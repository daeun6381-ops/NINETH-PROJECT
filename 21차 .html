<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mate Diary - ìš°ë¦¬ë“¤ì˜ ê¸°ë¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&family=Nanum+Pen+Script&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; min-height: 100vh; overflow-x: hidden; }
        .font-handwriting { font-family: 'Nanum Pen Script', cursive; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #0d9488; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal.active { display: flex !important; }
        #main-body { transition: background 1s ease-in-out; }
        .hidden { display: none !important; }
    </style>
</head>
<body id="main-body" class="bg-slate-50 text-slate-800">

    <!-- [1] ì—°ê²° í™”ë©´ (ì´ˆê¸° í™”ë©´) -->
    <div id="connection-screen" class="fixed inset-0 bg-slate-100 z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center border border-slate-200">
            <h2 class="text-3xl font-bold text-teal-600 mb-6 font-handwriting">ìš°ë¦¬ë“¤ì˜ ì¼ê¸°ì¥</h2>
            
            <div id="setup-step-1">
                <p class="text-slate-500 mb-8 text-sm leading-relaxed">ì†Œì¤‘í•œ ì‚¬ëŒê³¼ ì—°ê²°í•˜ì—¬<br>ì‹¤ì‹œê°„ìœ¼ë¡œ ì¼ê¸°ë¥¼ ê³µìœ í•´ë³´ì„¸ìš”.</p>
                <button onclick="showStep('join')" class="w-full bg-teal-500 text-white font-bold py-4 rounded-2xl mb-3 hover:bg-teal-600 transition shadow-lg shadow-teal-100">ì½”ë“œ ì…ë ¥í•˜ê³  ì‹œì‘í•˜ê¸°</button>
                <button onclick="handleCreateCode()" class="w-full bg-white border-2 border-teal-500 text-teal-500 font-bold py-4 rounded-2xl hover:bg-teal-50 transition">ìƒˆë¡œìš´ ì—°ê²° ì½”ë“œ ë§Œë“¤ê¸°</button>
            </div>

            <div id="setup-step-join" class="hidden">
                <p class="text-sm text-slate-500 mb-4 text-center font-bold text-teal-600">ì…ì¥ ì½”ë“œ ì…ë ¥</p>
                <input id="join-code-input" type="text" placeholder="6ìë¦¬ ì½”ë“œ" maxlength="6" class="w-full p-4 rounded-2xl bg-slate-50 mb-4 border-2 border-teal-100 focus:border-teal-400 outline-none text-center font-bold tracking-widest uppercase text-xl">
                <button onclick="handleJoin()" class="w-full bg-teal-600 text-white font-bold py-4 rounded-2xl mb-3">ì—°ê²°í•˜ê¸°</button>
                <button onclick="showStep('1')" class="text-slate-400 text-sm underline cursor-pointer">ë’¤ë¡œê°€ê¸°</button>
            </div>

            <div id="setup-step-wait" class="hidden">
                <p class="text-sm text-slate-500 mb-3">ìƒëŒ€ë°©ì—ê²Œ ì•„ë˜ ì½”ë“œë¥¼ ì „ë‹¬í•˜ì„¸ìš”</p>
                <div id="generated-code-display" class="text-3xl font-bold text-teal-600 tracking-widest mb-6 bg-teal-50 py-5 rounded-2xl border-2 border-dashed border-teal-200">------</div>
                <div class="flex flex-col items-center gap-3">
                    <div class="loader"></div>
                    <p class="text-xs text-teal-500 animate-pulse">ìƒëŒ€ë°©ì´ ì½”ë“œë¥¼ ì…ë ¥í•˜ê¸¸ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”...</p>
                    <button onclick="window.location.reload()" class="mt-4 text-slate-400 text-sm underline cursor-pointer">ì·¨ì†Œí•˜ê³  ë‹¤ì‹œí•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- [2] ë©”ì¸ ë ˆì´ì•„ì›ƒ -->
    <header class="bg-white/70 backdrop-blur-md py-8 px-4 text-center border-b border-white/20">
        <div class="max-w-4xl mx-auto relative">
            <button onclick="toggleModal('settings-modal', true)" class="absolute top-0 right-0 p-2 text-slate-400 hover:text-teal-500 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
            <h1 id="d-day-display" class="text-4xl font-bold text-teal-600 font-handwriting">í•¨ê»˜í•œ ì§€ 1ì¼</h1>
            <p class="text-xs text-slate-400 mt-2 font-bold tracking-widest"><span id="nick-me">ë‚˜</span> â¤ï¸ <span id="nick-partner">ìƒëŒ€ë°©</span></p>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-6">
        <section class="bg-white rounded-3xl p-6 shadow-sm mb-10 border border-slate-100">
            <input id="diary-title" type="text" placeholder="ì˜¤ëŠ˜ì˜ ì œëª©" class="w-full p-4 mb-4 rounded-xl bg-slate-50 border-none outline-none focus:ring-2 ring-teal-100 font-bold">
            <textarea id="diary-content" rows="4" placeholder="ì˜¤ëŠ˜ ì–´ë–¤ ì†Œì¤‘í•œ ì¼ì´ ìˆì—ˆë‚˜ìš”?" class="w-full p-4 mb-4 rounded-xl bg-slate-50 border-none outline-none focus:ring-2 ring-teal-100 resize-none"></textarea>
            
            <div id="image-preview-box" class="hidden relative mb-4 w-full max-w-xs aspect-square rounded-2xl overflow-hidden border">
                <img id="img-preview" src="" class="w-full h-full object-cover">
                <button onclick="removeImage()" class="absolute top-2 right-2 bg-black/50 text-white rounded-full w-8 h-8 flex items-center justify-center transition hover:bg-black/70">&times;</button>
            </div>

            <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <label class="cursor-pointer bg-slate-100 p-3 rounded-xl hover:bg-slate-200 transition border border-slate-200" title="ì‚¬ì§„ ì¶”ê°€">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <input type="file" id="input-file" class="hidden" accept="image/*" onchange="handleImage(this)">
                    </label>
                    <select id="diary-mood" class="bg-slate-100 p-3 rounded-xl text-sm outline-none border border-slate-200">
                        <option value="ğŸ˜Š">ğŸ˜Š í‰ì˜¨</option><option value="âœ¨">âœ¨ ê¸°ì¨</option><option value="ğŸ¥±">ğŸ¥± í”¼ê³¤</option><option value="ğŸ•">ğŸ• ë§›ë‚¨</option><option value="â˜ï¸">â˜ï¸ ìš°ìš¸</option>
                    </select>
                </div>
                <button onclick="handleSaveDiary()" id="btn-save" class="bg-teal-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-teal-600 transition flex-1 sm:flex-none">ê¸°ë¡í•˜ê¸°</button>
            </div>
        </section>

        <div id="diary-list" class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-20">
            <div class="col-span-full text-center py-20 text-slate-400">ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        </div>
    </main>

    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div id="settings-modal" class="modal">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl mx-4 border border-slate-200">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl">ê³µê°„ ê´€ë¦¬</h3>
                <button onclick="toggleModal('settings-modal', false)" class="text-3xl leading-none text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 uppercase">ìš°ë¦¬ì˜ ì‹œì‘ì¼</label>
                    <input id="set-date" type="date" class="w-full p-4 bg-slate-50 rounded-xl outline-none border border-slate-100 focus:border-teal-400">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-2 uppercase">ë‚˜ì˜ ì´ë¦„</label>
                        <input id="set-my-nick" type="text" maxlength="6" class="w-full p-4 bg-slate-50 rounded-xl outline-none border border-slate-100">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-2 uppercase">ë„ˆì˜ ì´ë¦„</label>
                        <input id="set-partner-nick" type="text" maxlength="6" class="w-full p-4 bg-slate-50 rounded-xl outline-none border border-slate-100">
                    </div>
                </div>
                <button onclick="handleSaveSettings()" class="w-full bg-teal-600 text-white font-bold py-4 rounded-2xl shadow-md hover:bg-teal-700 transition mt-2">ì €ì¥í•˜ê¸°</button>
                <button onclick="handleLogout()" class="w-full text-slate-300 text-[10px] underline pt-4 uppercase tracking-tighter">ì—°ê²° í•´ì œ ë° ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // 1. Firebase ì„¤ì •
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'shared-diary-final-01';

        let user = null;
        let activeCode = localStorage.getItem('active_room_code');
        let tempBase64 = null;

        // 2. ì „ì—­ í•¨ìˆ˜ ì„¤ì • (í•¨ìˆ˜ ì„ ì–¸ ìˆœì„œ ì¤‘ìš” - HTML í˜¸ì¶œ ëŒ€ë¹„)
        window.showStep = (step) => {
            document.getElementById('setup-step-1').classList.add('hidden');
            document.getElementById('setup-step-join').classList.add('hidden');
            document.getElementById('setup-step-wait').classList.add('hidden');
            if(step === '1') document.getElementById('setup-step-1').classList.remove('hidden');
            else if(step === 'join') document.getElementById('setup-step-join').classList.remove('hidden');
            else if(step === 'wait') document.getElementById('setup-step-wait').classList.remove('hidden');
        };

        window.toggleModal = (id, show) => {
            const m = document.getElementById(id);
            if(show) m.classList.add('active');
            else m.classList.remove('active');
        };

        window.handleCreateCode = async () => {
            if(!user) {
                alert("ì¸ì¦ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
                return;
            }
            const code = Math.random().toString(36).substring(2, 8).toUpperCase();
            document.getElementById('generated-code-display').innerText = code;
            window.showStep('wait');

            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', code);
            await setDoc(roomRef, {
                host: user.uid,
                status: 'waiting',
                startDate: new Date().toISOString().split('T')[0],
                nicks: { [user.uid]: 'ë‚˜' },
                lastWritten: {}
            });

            // ì—°ê²° ëŒ€ê¸° ëª¨ë‹ˆí„°ë§
            onSnapshot(roomRef, (snap) => {
                if(snap.exists() && snap.data().status === 'connected') {
                    localStorage.setItem('active_room_code', code);
                    window.location.reload();
                }
            });
        };

        window.handleJoin = async () => {
            const code = document.getElementById('join-code-input').value.trim().toUpperCase();
            if(!code) return;

            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', code);
            try {
                const snap = await getDoc(roomRef);
                if(snap.exists() && snap.data().status === 'waiting') {
                    await updateDoc(roomRef, {
                        status: 'connected',
                        guest: user.uid,
                        [`nicks.${user.uid}`]: 'ìƒëŒ€ë°©'
                    });
                    localStorage.setItem('active_room_code', code);
                    window.location.reload();
                } else {
                    alert('ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ì´ë¯¸ ë§Œë£Œëœ ì½”ë“œì…ë‹ˆë‹¤.');
                }
            } catch(e) { alert('ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
        };

        window.handleImage = (input) => {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const max = 800;
                    if (width > height) { if (width > max) { height *= max / width; width = max; } }
                    else { if (height > max) { width *= max / height; height = max; } }
                    canvas.width = width; canvas.height = height;
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    tempBase64 = canvas.toDataURL('image/jpeg', 0.6);
                    document.getElementById('img-preview').src = tempBase64;
                    document.getElementById('image-preview-box').classList.remove('hidden');
                };
            };
            reader.readAsDataURL(file);
        };

        window.removeImage = () => {
            tempBase64 = null;
            document.getElementById('image-preview-box').classList.add('hidden');
            document.getElementById('input-file').value = '';
        };

        window.handleSaveDiary = async () => {
            const title = document.getElementById('diary-title').value.trim();
            const content = document.getElementById('diary-content').value.trim();
            if(!title || !content || !activeCode) return;

            const btn = document.getElementById('btn-save');
            btn.disabled = true; btn.innerText = "ê¸°ë¡ ì¤‘...";

            const today = new Date().toLocaleDateString('ko-KR');
            const mood = document.getElementById('diary-mood').value;

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'diaries_' + activeCode), {
                    title, content, author: user.uid, mood, image: tempBase64, date: today, createdAt: serverTimestamp()
                });
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', activeCode), {
                    [`lastWritten.${user.uid}`]: today
                });
                document.getElementById('diary-title').value = '';
                document.getElementById('diary-content').value = '';
                window.removeImage();
            } catch (e) { alert('ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
            finally { btn.disabled = false; btn.innerText = "ê¸°ë¡í•˜ê¸°"; }
        };

        window.handleSaveSettings = async () => {
            const startDate = document.getElementById('set-date').value;
            const myNick = document.getElementById('set-my-nick').value.trim();
            const partnerNick = document.getElementById('set-partner-nick').value.trim();
            if(!activeCode) return;

            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', activeCode);
            const snap = await getDoc(roomRef);
            const data = snap.data();
            const partnerId = data.host === user.uid ? data.guest : data.host;

            const updates = { startDate, [`nicks.${user.uid}`]: myNick || 'ë‚˜' };
            if(partnerId) updates[`nicks.${partnerId}`] = partnerNick || 'ë„ˆ';

            await updateDoc(roomRef, updates);
            window.toggleModal('settings-modal', false);
        };

        window.handleLogout = () => {
            if(confirm('ì—°ê²°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì €ì¥ëœ ì¼ê¸°ëŠ” ì‚­ì œë˜ì§€ ì•Šì§€ë§Œ ë‹¤ì‹œ ì½”ë“œë¡œ ì…ì¥í•´ì•¼ í•©ë‹ˆë‹¤)')) {
                localStorage.removeItem('active_room_code');
                window.location.reload();
            }
        };

        // 3. ì•± ì´ˆê¸°í™” ë° ì‹¤í–‰ ë¡œì§
        const startApp = (code) => {
            // ì—°ê²° í™”ë©´ ìˆ¨ê¸°ê¸°
            document.getElementById('connection-screen').classList.add('hidden');
            
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', code);
            const diaryCol = collection(db, 'artifacts', appId, 'public', 'data', 'diaries_' + code);

            // ë°© ì •ë³´ ì‹¤ì‹œê°„ êµ¬ë…
            onSnapshot(roomRef, (snap) => {
                const d = snap.data();
                if(!d) return;

                // D-Day ê³„ì‚°
                const start = new Date(d.startDate);
                const today = new Date();
                today.setHours(0,0,0,0); start.setHours(0,0,0,0);
                const days = Math.floor((today - start) / 86400000) + 1;
                document.getElementById('d-day-display').innerText = `í•¨ê»˜í•œ ì§€ ${days}ì¼`;
                document.getElementById('set-date').value = d.startDate;

                // ë³„ëª… í‘œì‹œ
                const partnerId = d.host === user.uid ? d.guest : d.host;
                document.getElementById('nick-me').innerText = d.nicks[user.uid] || 'ë‚˜';
                document.getElementById('nick-partner').innerText = partnerId ? (d.nicks[partnerId] || 'ìƒëŒ€ë°©') : 'ìƒëŒ€ë°©';
                
                // ì¼ê¸° ëª©ë¡ ë Œë”ë§ ì‹œì‘
                renderDiaries(diaryCol, d.lastWritten || {}, partnerId);
            });
        };

        const renderDiaries = (col, lastWritten, partnerId) => {
            onSnapshot(col, (snap) => {
                const list = document.getElementById('diary-list');
                list.innerHTML = '';
                const items = [];
                snap.forEach(d => items.push({ id: d.id, ...d.data() }));
                
                // ìµœì‹ ìˆœ ì •ë ¬
                items.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                if(items.length === 0) {
                    list.innerHTML = '<div class="col-span-full text-center py-20 text-slate-300">í•¨ê»˜ ì¨ ë‚´ë ¤ê°ˆ ì²« í˜ì´ì§€ë¥¼ ê¸°ë‹¤ë ¤ìš”.</div>';
                    return;
                }

                items.forEach(data => {
                    const isMy = data.author === user.uid;
                    // ì ê¸ˆ ë¡œì§: ë‚´ê°€ ì˜¤ëŠ˜ ì¼ê¸°ë¥¼ ì“°ì§€ ì•Šì•˜ê³ , ìƒëŒ€ë°©ì´ ì¼ê¸°ë¥¼ ì“´ ê²½ìš° (êµí™˜ ì¼ê¸° ê·œì¹™)
                    const isLocked = !isMy && partnerId && (lastWritten[user.uid] !== data.date);

                    const div = document.createElement('div');
                    div.className = "bg-white p-6 rounded-3xl shadow-sm border border-slate-50 diary-card";
                    
                    if(isLocked) {
                        div.innerHTML = `<div class="flex items-center justify-center h-48 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200"><p class="text-sm text-slate-400 font-bold">ğŸ”’ ì˜¤ëŠ˜ ì¼ê¸°ë¥¼ ì“°ë©´ ì—´ë ¤ìš”!</p></div>`;
                    } else {
                        const imgTag = data.image ? `<img src="${data.image}" class="w-full h-48 object-cover rounded-2xl mb-4 border border-slate-50">` : '';
                        div.innerHTML = `
                            <div class="flex justify-between items-start mb-3">
                                <span class="text-[10px] font-bold text-slate-300">${data.date}</span>
                                <span class="text-xl">${data.mood}</span>
                            </div>
                            ${imgTag}
                            <h4 class="font-bold text-slate-800 mb-1">${data.title}</h4>
                            <p class="text-sm text-slate-500 leading-relaxed whitespace-pre-wrap">${data.content}</p>
                            <div class="mt-4 pt-4 border-t border-slate-50 text-[9px] font-bold ${isMy ? 'text-teal-400' : 'text-slate-300'} uppercase">${isMy ? 'MY RECORD' : 'PARTNER RECORD'}</div>
                        `;
                    }
                    list.appendChild(div);
                });
            }, (err) => console.error("ì¼ê¸° ë¡œë“œ ì˜¤ë¥˜:", err));
        };

        // 4. ì¸ì¦ ì²˜ë¦¬ (App ì‹œì‘ì )
        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                // ì¸ì¦ ì™„ë£Œ í›„, ì—°ê²°ëœ ì½”ë“œê°€ ìˆìœ¼ë©´ ì•± ì‹¤í–‰
                if (activeCode) {
                    startApp(activeCode);
                }
            } else {
                signInAnonymously(auth);
            }
        });
    </script>
</body>
</html>